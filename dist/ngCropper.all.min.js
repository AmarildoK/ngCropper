!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):t(jQuery)}(function(t){"use strict";var e=t(window),i=t(document),h=".cropper",r=/^(\+|\*|e|n|w|s|ne|nw|sw|se)$/i,n=/^(x|y|width|height)$/i,a="cropper-hidden",s="cropper-invisible",o="mousedown touchstart",d="mousemove touchmove",g="mouseup mouseleave touchend touchleave touchcancel",c="resize"+h,p=["build"+h,"built"+h,"dragstart"+h,"dragmove"+h,"dragend"+h,"render"+h],u=function(t){return"number"==typeof t},l=function(t){return'<img src="'+t+'">'},f=function(e,i){this.$element=t(e),this.setDefaults(i),this.init()},m=Math.round,v=Math.min,w=Math.max,x=Math.abs,$=parseFloat;f.prototype={constructor:f,setDefaults:function(e){e=t.extend({},f.defaults,t.isPlainObject(e)?e:{}),t.each(e,function(t,i){switch(t){case"aspectRatio":e[t]=x($(i))||0/0;break;case"minWidth":case"minHeight":e[t]=x($(i))||0;break;case"maxWidth":case"maxHeight":e[t]=x($(i))||1/0}}),this.defaults=e},init:function(){var e,i,h=this,r=this.$element,n=r[0],a={};r.is("img")?e=r.attr("src"):r.is("canvas")&&n.getContext&&(e=n.toDataURL()),e&&(this.$clone&&this.$clone.remove(),this.$clone=i=t(l(e)),i.one("load",function(){a.naturalWidth=this.naturalWidth||i.width(),a.naturalHeight=this.naturalHeight||i.height(),a.aspectRatio=a.naturalWidth/a.naturalHeight,h.active=!0,h.src=e,h.image=a,h.build()}),i.addClass(s).prependTo("body"))},build:function(){var e,h,r=this.$element,n=this.defaults;this.built&&this.unbuild(),e=t.Event(p[0]),r.trigger(e),t.isFunction(n.build)&&n.build(e),e.isDefaultPrevented()||(this.$cropper=h=t(f.template),r.addClass(a),this.$clone.removeClass(s).prependTo(h),this.$container=r.parent(),this.$container.append(h),this.$modal=h.find(".cropper-modal"),this.$canvas=h.find(".cropper-canvas"),this.$dragger=h.find(".cropper-dragger"),this.$viewer=h.find(".cropper-viewer"),this.cropped=!0,n.autoCrop||(this.$dragger.addClass(a),this.cropped=!1),this.$modal.toggleClass(a,!n.modal),this.$canvas.toggleClass(a,!n.dragCrop),!n.dashed&&this.$dragger.find(".cropper-dashed").addClass(a),!(n.movable||n.moveable)&&this.$dragger.find(".cropper-face").addClass(a),!(n.resizable||n.resizeable)&&this.$dragger.find(".cropper-line, .cropper-point").addClass(a),this.$dragScope=n.multiple?this.$cropper:i,this.addListener(),this.initPreview(),this.built=!0,this.update(),r.trigger(p[1]))},unbuild:function(){this.built&&(this.built=!1,this.removeListener(),this.$preview.empty(),this.$preview=null,this.$dragger=null,this.$canvas=null,this.$modal=null,this.$container=null,this.$cropper.remove(),this.$cropper=null)},update:function(t){this.initContainer(),this.initCropper(),this.initDragger(),t?this.setData(t,!0):this.setData(this.defaults.data)},resize:function(){clearTimeout(this.resizing),this.resizing=setTimeout(t.proxy(this.update,this,this.getData()),200)},reset:function(t){this.cropped&&(t&&(this.defaults.data={}),this.dragger=this.cloneDragger(),this.setData(this.defaults.data))},release:function(){this.cropped&&(this.cropped=!1,this.defaults.done({x:0,y:0,width:0,height:0}),this.$dragger.addClass(a))},destroy:function(){var t=this.$element;this.active&&(this.unbuild(),t.removeClass(a),t.removeData("cropper"),t=null)},preview:function(){var e=this.cropper,i=this.dragger;this.$viewer.find("img").css({height:m(e.height),marginLeft:-m(i.left),marginTop:-m(i.top),width:m(e.width)}),this.$preview.each(function(){var h=t(this),r=h.width()/i.width,n={height:m(e.height*r),marginLeft:-m(i.left*r),marginTop:-m(i.top*r),width:m(e.width*r)};h.find("img").css(n)})},addListener:function(){var i=this.$element,r=this.defaults;t.each(p,function(e,n){var a=r[p[e].replace(h,"")];t.isFunction(a)&&i.on(n,a)}),this.$cropper.on(o,t.proxy(this.dragstart,this)),this.$dragScope.on(d,t.proxy(this.dragmove,this)).on(g,t.proxy(this.dragend,this)),e.on(c,t.proxy(this.resize,this))},removeListener:function(){var i=this.$element,r=this.defaults;t.each(p,function(e,n){var a=r[p[e].replace(h,"")];t.isFunction(a)&&i.off(n,a)}),this.$cropper.off(o,this.dragstart),this.$dragScope.off(d,this.dragmove).off(g,this.dragend),e.off(c,this.resize)},initPreview:function(){var e=l(this.src);this.$preview=t(this.defaults.preview),this.$preview.html(e),this.$viewer.html(e)},initContainer:function(){var t=this.$container;this.container={width:t.width(),height:t.height()}},initCropper:function(){var t,e=this.container,i=this.image;i.naturalWidth*e.height/i.naturalHeight-e.width>=0?(t={height:e.width/i.aspectRatio,width:e.width,left:0},t.top=(e.height-t.height)/2):(t={height:e.height,width:e.height*i.aspectRatio,top:0},t.left=(e.width-t.width)/2),i.ratio=t.width/i.naturalWidth,i.height=t.height,i.width=t.width,this.$cropper.css({height:m(t.height),left:m(t.left),top:m(t.top),width:m(t.width)}),this.cropper=t},initDragger:function(){var t,e=this.defaults,i=this.cropper,h=e.aspectRatio||this.image.aspectRatio,r=this.image.ratio;t=i.height*h-i.width>=0?{height:i.width/h,width:i.width,left:0,top:(i.height-i.width/h)/2,maxWidth:i.width,maxHeight:i.width/h}:{height:i.height,width:i.height*h,left:(i.width-i.height*h)/2,top:0,maxWidth:i.height*h,maxHeight:i.height},t.minWidth=0,t.minHeight=0,e.aspectRatio?(isFinite(e.maxWidth)?(t.maxWidth=v(t.maxWidth,e.maxWidth*r),t.maxHeight=t.maxWidth/h):isFinite(e.maxHeight)&&(t.maxHeight=v(t.maxHeight,e.maxHeight*r),t.maxWidth=t.maxHeight*h),e.minWidth>0?(t.minWidth=w(0,e.minWidth*r),t.minHeight=t.minWidth/h):e.minHeight>0&&(t.minHeight=w(0,e.minHeight*r),t.minWidth=t.minHeight*h)):(t.maxWidth=v(t.maxWidth,e.maxWidth*r),t.maxHeight=v(t.maxHeight,e.maxHeight*r),t.minWidth=w(0,e.minWidth*r),t.minHeight=w(0,e.minHeight*r)),t.minWidth=v(t.maxWidth,t.minWidth),t.minHeight=v(t.maxHeight,t.minHeight),t.height*=.8,t.width*=.8,t.left=(i.width-t.width)/2,t.top=(i.height-t.height)/2,this.defaultDragger=t,this.dragger=this.cloneDragger(),this.draggerLeft=t.left,this.draggerTop=t.top},cloneDragger:function(){return t.extend({},this.defaultDragger)},renderDragger:function(){var t,e,i=this.dragger,h=this.cropper,r=this.draggerLeft,n=this.draggerTop;i.width>i.maxWidth?(i.width=i.maxWidth,i.left=r):i.width<i.minWidth&&(i.width=i.minWidth,i.left=r),i.height>i.maxHeight?(i.height=i.maxHeight,i.top=n):i.height<i.minHeight&&(i.height=i.minHeight,i.top=n),t=h.width-i.width,e=h.height-i.height,i.left=i.left>t?t:i.left<0?0:i.left,i.top=i.top>e?e:i.top<0?0:i.top,this.dragger=i,this.draggerLeft=i.left,this.draggerTop=i.top,this.defaults.done(this.getData()),this.$dragger.css({height:m(i.height),left:m(i.left),top:m(i.top),width:m(i.width)}),this.preview()},setData:function(e,i){var h=this.cropper,r=this.dragger,n=this.defaults.aspectRatio;this.built&&"undefined"!=typeof e&&((null===e||t.isEmptyObject(e))&&(r=this.cloneDragger()),t.isPlainObject(e)&&!t.isEmptyObject(e)&&(i||(this.defaults.data=e),e=this.transformData(e),u(e.x)&&e.x<=h.width&&(r.left=e.x),u(e.y)&&e.y<=h.height&&(r.top=e.y),n?u(e.width)&&e.width<=r.maxWidth&&e.width>=r.minWidth?(r.width=e.width,r.height=r.width/n):u(e.height)&&e.height<=r.maxHeight&&e.height>=r.minHeight&&(r.height=e.height,r.width=r.height*n):(u(e.width)&&e.width<=r.maxWidth&&e.width>=r.minWidth&&(r.width=e.width),u(e.height)&&e.height<=r.maxHeight&&e.height>=r.minHeight&&(r.height=e.height))),this.dragger=r,this.renderDragger())},getData:function(){var t=this.dragger,e={};return this.built&&(e={x:t.left,y:t.top,width:t.width,height:t.height},e=this.transformData(e,!0)),e},transformData:function(e,i){var h=this.image.ratio,r={};return t.each(e,function(t,e){e=$(e),n.test(t)&&!isNaN(e)&&(r[t]=i?m(e/h):e*h)}),r},setAspectRatio:function(t){var e="auto"===t;t=$(t),(e||!isNaN(t)&&t>0)&&(this.defaults.aspectRatio=e?0/0:t,this.built&&(this.initDragger(),this.renderDragger()))},setImgSrc:function(e){var i,h=this,r=this.$element,n=r[0];e&&e!==this.src&&(r.is("img")?(r.attr("src",e),this.init()):r.is("canvas")&&n.getContext&&(i=n.getContext("2d"),t(l(e)).one("load",function(){n.width=this.width,n.height=this.height,i.clearRect(0,0,n.width,n.height),i.drawImage(this,0,0),h.init()})))},getImgInfo:function(){return this.image||{}},dragstart:function(e){var i,h,n=(e.originalEvent||e).touches,s=e;if(n){if(n.length>1)return;s=n[0],this.touchId=s.identifier}if(i=t(s.target).data("direction"),r.test(i)){if(e.preventDefault(),h=t.Event(p[2]),this.$element.trigger(h),h.isDefaultPrevented())return;this.direction=i,this.startX=s.pageX,this.startY=s.pageY,"+"===i&&(this.cropping=!0,this.$modal.removeClass(a))}},dragmove:function(e){var i,h=(e.originalEvent||e).changedTouches,r=e;if(h){if(h.length>1)return;if(r=h[0],r.identifier!==this.touchId)return}if(this.direction){if(e.preventDefault(),i=t.Event(p[3]),this.$element.trigger(i),i.isDefaultPrevented())return;this.endX=r.pageX,this.endY=r.pageY,this.dragging()}},dragend:function(e){var i,h=(e.originalEvent||e).changedTouches,r=e;if(h){if(h.length>1)return;if(r=h[0],r.identifier!==this.touchId)return}if(this.direction){if(e.preventDefault(),i=t.Event(p[4]),this.$element.trigger(i),i.isDefaultPrevented())return;this.cropping&&(this.cropping=!1,this.$modal.toggleClass(a,!this.defaults.modal)),this.direction=""}},dragging:function(){var t,e=this.direction,i=this.cropper,h=i.width,r=i.height,n=this.dragger,s=n.width,o=n.height,d=n.left,g=n.top,c=d+s,p=g+o,u=!0,l=this.defaults.aspectRatio,f={x:this.endX-this.startX,y:this.endY-this.startY};switch(l&&(f.X=f.y*l,f.Y=f.x/l),e){case"+":f.x&&f.y&&(t=this.$cropper.offset(),d=this.startX-t.left,g=this.startY-t.top,s=n.minWidth,o=n.minHeight,f.x>0?f.y>0?e="se":(e="ne",g-=o):f.y>0?(e="sw",d-=s):(e="nw",d-=s,g-=o),this.cropped||(this.cropped=!0,this.$dragger.removeClass(a)));break;case"*":d+=f.x,g+=f.y;break;case"e":if(f.x>=0&&(c>=h||l&&(0>=g||p>=r))){u=!1;break}s+=f.x,l&&(o=s/l,g-=f.Y/2),0>s&&(e="w",s=0);break;case"n":if(f.y<=0&&(0>=g||l&&(0>=d||c>=h))){u=!1;break}o-=f.y,g+=f.y,l&&(s=o*l,d+=f.X/2),0>o&&(e="s",o=0);break;case"w":if(f.x<=0&&(0>=d||l&&(0>=g||p>=r))){u=!1;break}s-=f.x,d+=f.x,l&&(o=s/l,g+=f.Y/2),0>s&&(e="e",s=0);break;case"s":if(f.y>=0&&(p>=r||l&&(0>=d||c>=h))){u=!1;break}o+=f.y,l&&(s=o*l,d-=f.X/2),0>o&&(e="n",o=0);break;case"ne":if(f.y<=0&&(0>=g||c>=h)){u=!1;break}o-=f.y,g+=f.y,l?s=o*l:s+=f.x,0>o&&(e="sw",o=0,s=0);break;case"nw":if(f.y<=0&&(0>=g||0>=d)){u=!1;break}o-=f.y,g+=f.y,l?(s=o*l,d+=f.X):(s-=f.x,d+=f.x),0>o&&(e="se",o=0,s=0);break;case"sw":if(f.x<=0&&(0>=d||p>=r)){u=!1;break}s-=f.x,d+=f.x,l?o=s/l:o+=f.y,0>s&&(e="ne",o=0,s=0);break;case"se":if(f.x>=0&&(c>=h||p>=r)){u=!1;break}s+=f.x,l?o=s/l:o+=f.y,0>s&&(e="nw",o=0,s=0)}u&&(n.width=s,n.height=o,n.left=d,n.top=g,this.direction=e,this.renderDragger()),this.startX=this.endX,this.startY=this.endY}},f.template=function(t,e){return e=e.split(","),t.replace(/\d+/g,function(t){return e[t]})}('<0 6="5-container"><0 6="5-modal"></0><0 6="5-canvas" 3-2="+"></0><0 6="5-dragger"><1 6="5-viewer"></1><1 6="5-8 8-h"></1><1 6="5-8 8-v"></1><1 6="5-face" 3-2="*"></1><1 6="5-7 7-e" 3-2="e"></1><1 6="5-7 7-n" 3-2="n"></1><1 6="5-7 7-w" 3-2="w"></1><1 6="5-7 7-s" 3-2="s"></1><1 6="5-4 4-e" 3-2="e"></1><1 6="5-4 4-n" 3-2="n"></1><1 6="5-4 4-w" 3-2="w"></1><1 6="5-4 4-s" 3-2="s"></1><1 6="5-4 4-ne" 3-2="ne"></1><1 6="5-4 4-nw" 3-2="nw"></1><1 6="5-4 4-sw" 3-2="sw"></1><1 6="5-4 4-se" 3-2="se"></1></0></0>',"div,span,direction,data,point,cropper,class,line,dashed"),f.defaults={aspectRatio:"auto",data:{},done:t.noop,preview:void 0,multiple:!1,autoCrop:!0,dragCrop:!0,dashed:!0,modal:!0,movable:!0,resizable:!0,minWidth:0,minHeight:0,maxWidth:1/0,maxHeight:1/0,build:void 0,built:void 0,dragstart:void 0,dragmove:void 0,dragend:void 0},f.setDefaults=function(e){t.extend(f.defaults,e)},f.other=t.fn.cropper,t.fn.cropper=function(e,i){var h=this;return this.each(function(){var r=t(this),n=r.data("cropper");n||r.data("cropper",n=new f(this,e)),"string"==typeof e&&t.isFunction(n[e])&&(h=n[e](i))}),"undefined"!=typeof h?h:this},t.fn.cropper.constructor=f,t.fn.cropper.setDefaults=f.setDefaults,t.fn.cropper.noConflict=function(){return t.fn.cropper=f.other,this}}),function(){"use strict";angular.module("ngCropper",["ng"]).directive("ngCropper",["$q",function(t){function e(e,r){e=e||{};var n=t.defer(),a=[i(e)];return e.maximize&&a.push(h(e,r)),t.all(a).then(function(t){var e=t[t.length-1];n.resolve(e)}),n.promise}function i(e){var i=t.defer();return i.resolve(e),i.promise}function h(e,i){var h=t.defer();return r(i).then(function(t){e.data=t,h.resolve(e)}),h.promise}function r(e){var i=t.defer(),h=new Image;return h.onload=function(){i.resolve({width:h.width,height:h.height})},h.src=e.src,i.promise}return{restrict:"A",scope:{options:"=ngOptions"},link:function(t,i,h){var r=!1;t.$on(h.ngShow,function(){r||(r=!0,e(t.options,i[0]).then(function(t){i.cropper(t)}))}),t.$on(h.ngHide,function(){r&&(r=!1,i.cropper("destroy"))})}}}]).service("Cropper",["$q",function(t){function e(e){var i=t.defer(),h=new Image;return h.onload=function(t){i.resolve(t.target)},h.src=e,i.promise}function i(t){var e=document.createElement("canvas");return e.width=t.width,e.height=t.height,e.style.display="none",document.body.appendChild(e),e}function h(t){t.parentElement.removeChild(t)}this.encode=function(e){var i=t.defer(),h=new FileReader;return h.onload=function(t){i.resolve(t.target.result)},h.readAsDataURL(e),i.promise},this.decode=function(t){for(var e=t.split(";")[0],i=e.split(":")[1],h=atob(t.split(",")[1]),r=new Uint8Array(h.length),n=0;n<h.length;n++)r[n]=h.charCodeAt(n);return new Blob([r],{type:i})},this.crop=function(e,r){var n=t.defer(),a=this.decode;return this.encode(e).then(function(t){var s=i(r),o=s.getContext("2d"),d=new Image;d.src=t,o.drawImage(d,r.x,r.y,r.width,r.height,0,0,r.width,r.height);var g=s.toDataURL(e.type),c=a(g);n.resolve(c),h(s)}),n.promise},this.scale=function(r,n){var a=t.defer(),s=this.decode;return this.encode(r).then(e).then(function(t){var e,o,d,g=t.height,c=t.width;angular.isNumber(n)&&(e=n,o=g*e,d=c*e),angular.isObject(n)&&(e=c/g,o=n.height,d=n.width,o&&!d?d=o*e:d&&!o&&(o=d/e));var p=i(n),u=p.getContext("2d");p.height=o,p.width=d,u.drawImage(t,0,0,c,g,0,0,d,o);var l=p.toDataURL(r.type),f=s(l);a.resolve(f),h(p)}),a.promise}}])}();
