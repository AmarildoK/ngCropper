!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):t(jQuery)}(function(t){"use strict";var i=t(window),e=t(document),h=".cropper",r=/^(\+|\*|e|n|w|s|ne|nw|sw|se)$/i,a=/^(x|y|width|height)$/i,n="cropper-hidden",s="cropper-invisible",d="mousedown touchstart",o="mousemove touchmove",g="mouseup mouseleave touchend touchleave touchcancel",c="resize"+h,p=["build"+h,"built"+h,"dragstart"+h,"dragmove"+h,"dragend"+h,"render"+h],l=function(t){return"number"==typeof t},u=function(t){return'<img src="'+t+'">'},f=function(i,e){this.$element=t(i),this.setDefaults(e),this.init()},m=Math.round,w=Math.min,v=Math.max,x=Math.abs,$=parseFloat;f.prototype={constructor:f,setDefaults:function(i){i=t.extend({},f.defaults,t.isPlainObject(i)?i:{}),t.each(i,function(t,e){switch(t){case"aspectRatio":i[t]=x($(e))||0/0;break;case"minWidth":case"minHeight":i[t]=x($(e))||0;break;case"maxWidth":case"maxHeight":i[t]=x($(e))||1/0}}),this.defaults=i},init:function(){var i,e,h=this,r=this.$element,a=r[0],n={};r.is("img")?i=r.attr("src"):r.is("canvas")&&a.getContext&&(i=a.toDataURL()),i&&(this.$clone&&this.$clone.remove(),this.$clone=e=t(u(i)),e.one("load",function(){n.naturalWidth=this.naturalWidth||e.width(),n.naturalHeight=this.naturalHeight||e.height(),n.aspectRatio=n.naturalWidth/n.naturalHeight,h.active=!0,h.src=i,h.image=n,h.build()}),e.addClass(s).prependTo("body"))},build:function(){var i,h,r=this.$element,a=this.defaults;this.built&&this.unbuild(),i=t.Event(p[0]),r.trigger(i),t.isFunction(a.build)&&a.build(i),i.isDefaultPrevented()||(this.$cropper=h=t(f.template),r.addClass(n),this.$clone.removeClass(s).prependTo(h),this.$container=r.parent(),this.$container.append(h),this.$modal=h.find(".cropper-modal"),this.$canvas=h.find(".cropper-canvas"),this.$dragger=h.find(".cropper-dragger"),this.$viewer=h.find(".cropper-viewer"),this.cropped=!0,a.autoCrop||(this.$dragger.addClass(n),this.cropped=!1),this.$modal.toggleClass(n,!a.modal),this.$canvas.toggleClass(n,!a.dragCrop),!a.dashed&&this.$dragger.find(".cropper-dashed").addClass(n),!(a.movable||a.moveable)&&this.$dragger.find(".cropper-face").addClass(n),!(a.resizable||a.resizeable)&&this.$dragger.find(".cropper-line, .cropper-point").addClass(n),this.$dragScope=a.multiple?this.$cropper:e,this.addListener(),this.initPreview(),this.built=!0,this.update(),r.trigger(p[1]))},unbuild:function(){this.built&&(this.built=!1,this.removeListener(),this.$preview.empty(),this.$preview=null,this.$dragger=null,this.$canvas=null,this.$modal=null,this.$container=null,this.$cropper.remove(),this.$cropper=null)},update:function(t){this.initContainer(),this.initCropper(),this.initDragger(),t?this.setData(t,!0):this.setData(this.defaults.data)},resize:function(){clearTimeout(this.resizing),this.resizing=setTimeout(t.proxy(this.update,this,this.getData()),200)},reset:function(t){this.cropped&&(t&&(this.defaults.data={}),this.dragger=this.cloneDragger(),this.setData(this.defaults.data))},release:function(){this.cropped&&(this.cropped=!1,this.defaults.done({x:0,y:0,width:0,height:0}),this.$dragger.addClass(n))},destroy:function(){var t=this.$element;this.active&&(this.unbuild(),t.removeClass(n),t.removeData("cropper"),t=null)},preview:function(){var i=this.cropper,e=this.dragger;this.$viewer.find("img").css({height:m(i.height),marginLeft:-m(e.left),marginTop:-m(e.top),width:m(i.width)}),this.$preview.each(function(){var h=t(this),r=h.width()/e.width,a={height:m(i.height*r),marginLeft:-m(e.left*r),marginTop:-m(e.top*r),width:m(i.width*r)};h.find("img").css(a)})},addListener:function(){var e=this.$element,r=this.defaults;t.each(p,function(i,a){var n=r[p[i].replace(h,"")];t.isFunction(n)&&e.on(a,n)}),this.$cropper.on(d,t.proxy(this.dragstart,this)),this.$dragScope.on(o,t.proxy(this.dragmove,this)).on(g,t.proxy(this.dragend,this)),i.on(c,t.proxy(this.resize,this))},removeListener:function(){var e=this.$element,r=this.defaults;t.each(p,function(i,a){var n=r[p[i].replace(h,"")];t.isFunction(n)&&e.off(a,n)}),this.$cropper.off(d,this.dragstart),this.$dragScope.off(o,this.dragmove).off(g,this.dragend),i.off(c,this.resize)},initPreview:function(){var i=u(this.src);this.$preview=t(this.defaults.preview),this.$preview.html(i),this.$viewer.html(i)},initContainer:function(){var t=this.$container;this.container={width:t.width(),height:t.height()}},initCropper:function(){var t,i=this.container,e=this.image;e.naturalWidth*i.height/e.naturalHeight-i.width>=0?(t={height:i.width/e.aspectRatio,width:i.width,left:0},t.top=(i.height-t.height)/2):(t={height:i.height,width:i.height*e.aspectRatio,top:0},t.left=(i.width-t.width)/2),e.ratio=t.width/e.naturalWidth,e.height=t.height,e.width=t.width,this.$cropper.css({height:m(t.height),left:m(t.left),top:m(t.top),width:m(t.width)}),this.cropper=t},initDragger:function(){var t,i=this.defaults,e=this.cropper,h=i.aspectRatio||this.image.aspectRatio,r=this.image.ratio;t=e.height*h-e.width>=0?{height:e.width/h,width:e.width,left:0,top:(e.height-e.width/h)/2,maxWidth:e.width,maxHeight:e.width/h}:{height:e.height,width:e.height*h,left:(e.width-e.height*h)/2,top:0,maxWidth:e.height*h,maxHeight:e.height},t.minWidth=0,t.minHeight=0,i.aspectRatio?(isFinite(i.maxWidth)?(t.maxWidth=w(t.maxWidth,i.maxWidth*r),t.maxHeight=t.maxWidth/h):isFinite(i.maxHeight)&&(t.maxHeight=w(t.maxHeight,i.maxHeight*r),t.maxWidth=t.maxHeight*h),i.minWidth>0?(t.minWidth=v(0,i.minWidth*r),t.minHeight=t.minWidth/h):i.minHeight>0&&(t.minHeight=v(0,i.minHeight*r),t.minWidth=t.minHeight*h)):(t.maxWidth=w(t.maxWidth,i.maxWidth*r),t.maxHeight=w(t.maxHeight,i.maxHeight*r),t.minWidth=v(0,i.minWidth*r),t.minHeight=v(0,i.minHeight*r)),t.minWidth=w(t.maxWidth,t.minWidth),t.minHeight=w(t.maxHeight,t.minHeight),t.height*=.8,t.width*=.8,t.left=(e.width-t.width)/2,t.top=(e.height-t.height)/2,this.defaultDragger=t,this.dragger=this.cloneDragger(),this.draggerLeft=t.left,this.draggerTop=t.top},cloneDragger:function(){return t.extend({},this.defaultDragger)},renderDragger:function(){var t,i,e=this.dragger,h=this.cropper,r=this.draggerLeft,a=this.draggerTop;e.width>e.maxWidth?(e.width=e.maxWidth,e.left=r):e.width<e.minWidth&&(e.width=e.minWidth,e.left=r),e.height>e.maxHeight?(e.height=e.maxHeight,e.top=a):e.height<e.minHeight&&(e.height=e.minHeight,e.top=a),t=h.width-e.width,i=h.height-e.height,e.left=e.left>t?t:e.left<0?0:e.left,e.top=e.top>i?i:e.top<0?0:e.top,this.dragger=e,this.draggerLeft=e.left,this.draggerTop=e.top,this.defaults.done(this.getData()),this.$dragger.css({height:m(e.height),left:m(e.left),top:m(e.top),width:m(e.width)}),this.preview()},setData:function(i,e){var h=this.cropper,r=this.dragger,a=this.defaults.aspectRatio;this.built&&"undefined"!=typeof i&&((null===i||t.isEmptyObject(i))&&(r=this.cloneDragger()),t.isPlainObject(i)&&!t.isEmptyObject(i)&&(e||(this.defaults.data=i),i=this.transformData(i),l(i.x)&&i.x<=h.width&&(r.left=i.x),l(i.y)&&i.y<=h.height&&(r.top=i.y),a?l(i.width)&&i.width<=r.maxWidth&&i.width>=r.minWidth?(r.width=i.width,r.height=r.width/a):l(i.height)&&i.height<=r.maxHeight&&i.height>=r.minHeight&&(r.height=i.height,r.width=r.height*a):(l(i.width)&&i.width<=r.maxWidth&&i.width>=r.minWidth&&(r.width=i.width),l(i.height)&&i.height<=r.maxHeight&&i.height>=r.minHeight&&(r.height=i.height))),this.dragger=r,this.renderDragger())},getData:function(){var t=this.dragger,i={};return this.built&&(i={x:t.left,y:t.top,width:t.width,height:t.height},i=this.transformData(i,!0)),i},transformData:function(i,e){var h=this.image.ratio,r={};return t.each(i,function(t,i){i=$(i),a.test(t)&&!isNaN(i)&&(r[t]=e?m(i/h):i*h)}),r},setAspectRatio:function(t){var i="auto"===t;t=$(t),(i||!isNaN(t)&&t>0)&&(this.defaults.aspectRatio=i?0/0:t,this.built&&(this.initDragger(),this.renderDragger()))},setImgSrc:function(i){var e,h=this,r=this.$element,a=r[0];i&&i!==this.src&&(r.is("img")?(r.attr("src",i),this.init()):r.is("canvas")&&a.getContext&&(e=a.getContext("2d"),t(u(i)).one("load",function(){a.width=this.width,a.height=this.height,e.clearRect(0,0,a.width,a.height),e.drawImage(this,0,0),h.init()})))},getImgInfo:function(){return this.image||{}},dragstart:function(i){var e,h,a=(i.originalEvent||i).touches,s=i;if(a){if(a.length>1)return;s=a[0],this.touchId=s.identifier}if(e=t(s.target).data("direction"),r.test(e)){if(i.preventDefault(),h=t.Event(p[2]),this.$element.trigger(h),h.isDefaultPrevented())return;this.direction=e,this.startX=s.pageX,this.startY=s.pageY,"+"===e&&(this.cropping=!0,this.$modal.removeClass(n))}},dragmove:function(i){var e,h=(i.originalEvent||i).changedTouches,r=i;if(h){if(h.length>1)return;if(r=h[0],r.identifier!==this.touchId)return}if(this.direction){if(i.preventDefault(),e=t.Event(p[3]),this.$element.trigger(e),e.isDefaultPrevented())return;this.endX=r.pageX,this.endY=r.pageY,this.dragging()}},dragend:function(i){var e,h=(i.originalEvent||i).changedTouches,r=i;if(h){if(h.length>1)return;if(r=h[0],r.identifier!==this.touchId)return}if(this.direction){if(i.preventDefault(),e=t.Event(p[4]),this.$element.trigger(e),e.isDefaultPrevented())return;this.cropping&&(this.cropping=!1,this.$modal.toggleClass(n,!this.defaults.modal)),this.direction=""}},dragging:function(){var t,i=this.direction,e=this.cropper,h=e.width,r=e.height,a=this.dragger,s=a.width,d=a.height,o=a.left,g=a.top,c=o+s,p=g+d,l=!0,u=this.defaults.aspectRatio,f={x:this.endX-this.startX,y:this.endY-this.startY};switch(u&&(f.X=f.y*u,f.Y=f.x/u),i){case"+":f.x&&f.y&&(t=this.$cropper.offset(),o=this.startX-t.left,g=this.startY-t.top,s=a.minWidth,d=a.minHeight,f.x>0?f.y>0?i="se":(i="ne",g-=d):f.y>0?(i="sw",o-=s):(i="nw",o-=s,g-=d),this.cropped||(this.cropped=!0,this.$dragger.removeClass(n)));break;case"*":o+=f.x,g+=f.y;break;case"e":if(f.x>=0&&(c>=h||u&&(0>=g||p>=r))){l=!1;break}s+=f.x,u&&(d=s/u,g-=f.Y/2),0>s&&(i="w",s=0);break;case"n":if(f.y<=0&&(0>=g||u&&(0>=o||c>=h))){l=!1;break}d-=f.y,g+=f.y,u&&(s=d*u,o+=f.X/2),0>d&&(i="s",d=0);break;case"w":if(f.x<=0&&(0>=o||u&&(0>=g||p>=r))){l=!1;break}s-=f.x,o+=f.x,u&&(d=s/u,g+=f.Y/2),0>s&&(i="e",s=0);break;case"s":if(f.y>=0&&(p>=r||u&&(0>=o||c>=h))){l=!1;break}d+=f.y,u&&(s=d*u,o-=f.X/2),0>d&&(i="n",d=0);break;case"ne":if(f.y<=0&&(0>=g||c>=h)){l=!1;break}d-=f.y,g+=f.y,u?s=d*u:s+=f.x,0>d&&(i="sw",d=0,s=0);break;case"nw":if(f.y<=0&&(0>=g||0>=o)){l=!1;break}d-=f.y,g+=f.y,u?(s=d*u,o+=f.X):(s-=f.x,o+=f.x),0>d&&(i="se",d=0,s=0);break;case"sw":if(f.x<=0&&(0>=o||p>=r)){l=!1;break}s-=f.x,o+=f.x,u?d=s/u:d+=f.y,0>s&&(i="ne",d=0,s=0);break;case"se":if(f.x>=0&&(c>=h||p>=r)){l=!1;break}s+=f.x,u?d=s/u:d+=f.y,0>s&&(i="nw",d=0,s=0)}l&&(a.width=s,a.height=d,a.left=o,a.top=g,this.direction=i,this.renderDragger()),this.startX=this.endX,this.startY=this.endY}},f.template=function(t,i){return i=i.split(","),t.replace(/\d+/g,function(t){return i[t]})}('<0 6="5-container"><0 6="5-modal"></0><0 6="5-canvas" 3-2="+"></0><0 6="5-dragger"><1 6="5-viewer"></1><1 6="5-8 8-h"></1><1 6="5-8 8-v"></1><1 6="5-face" 3-2="*"></1><1 6="5-7 7-e" 3-2="e"></1><1 6="5-7 7-n" 3-2="n"></1><1 6="5-7 7-w" 3-2="w"></1><1 6="5-7 7-s" 3-2="s"></1><1 6="5-4 4-e" 3-2="e"></1><1 6="5-4 4-n" 3-2="n"></1><1 6="5-4 4-w" 3-2="w"></1><1 6="5-4 4-s" 3-2="s"></1><1 6="5-4 4-ne" 3-2="ne"></1><1 6="5-4 4-nw" 3-2="nw"></1><1 6="5-4 4-sw" 3-2="sw"></1><1 6="5-4 4-se" 3-2="se"></1></0></0>',"div,span,direction,data,point,cropper,class,line,dashed"),f.defaults={aspectRatio:"auto",data:{},done:t.noop,preview:void 0,multiple:!1,autoCrop:!0,dragCrop:!0,dashed:!0,modal:!0,movable:!0,resizable:!0,minWidth:0,minHeight:0,maxWidth:1/0,maxHeight:1/0,build:void 0,built:void 0,dragstart:void 0,dragmove:void 0,dragend:void 0},f.setDefaults=function(i){t.extend(f.defaults,i)},f.other=t.fn.cropper,t.fn.cropper=function(i,e){var h=this;return this.each(function(){var r=t(this),a=r.data("cropper");a||r.data("cropper",a=new f(this,i)),"string"==typeof i&&t.isFunction(a[i])&&(h=a[i](e))}),"undefined"!=typeof h?h:this},t.fn.cropper.constructor=f,t.fn.cropper.setDefaults=f.setDefaults,t.fn.cropper.noConflict=function(){return t.fn.cropper=f.other,this}}),function(){"use strict";angular.module("ngCropper",[]).directive("ngCropper",function(){return{restrict:"A",scope:{onDone:"=ngDone"},link:function(t,i,e){var h=e.ngShowEvent,r=e.ngHideEvent,a=angular.extend({aspectRatio:"auto",done:t.onDone||angular.noop},e);t.$on(h,function(){i.cropper(a)}),t.$on(r,function(){i.cropper("destroy")})}}}).service("Cropper",["$q",function(t){function i(t){var i=document.createElement("canvas");return i.width=t.width,i.height=t.height,i.style.display="none",document.body.appendChild(i),i}function e(t){t.parentElement.removeChild(t)}this.encode=function(i){var e=t.defer(),h=new FileReader;return h.onload=function(){e.resolve(h.result)},h.readAsDataURL(i),e.promise},this.decode=function(t){for(var i=t.split(";")[0],e=i.split(":")[1],h=atob(t.split(",")[1]),r=new Uint8Array(h.length),a=0;a<h.length;a++)r[a]=h.charCodeAt(a);return new Blob([r],{type:e})},this.crop=function(h,r){var a=t.defer(),n=(h.type,this.decode);return this.encode(h).then(function(t){var s=i(r),d=s.getContext("2d"),o=new Image;o.src=t,d.drawImage(o,r.x,r.y,r.width,r.height,0,0,r.width,r.height);var g=s.toDataURL(h.type),c=n(g);a.resolve(c),e(s)}),a.promise}}])}();
